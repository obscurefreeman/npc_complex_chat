<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>NPC 名字管理器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .name-list {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
        }
        .name-entry {
            display: grid;
            grid-template-columns: 1fr 1fr 40px;
            gap: 10px;
            margin-bottom: 10px;
        }
        .name-entry input {
            padding: 5px;
        }
        .buttons {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #exportArea {
            width: 100%;
            height: 200px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>NPC 名字管理器</h1>
    
    <div class="buttons">
        <button onclick="importFiles()">导入现有文件</button>
        <button onclick="exportFiles()">导出文件</button>
        <input type="file" multiple onchange="manualImport(this.files)" accept=".json" />
    </div>

    <div class="container">
        <div class="name-list">
            <h2>男性名字</h2>
            <div id="maleNames"></div>
            <button onclick="addMaleName()">添加男性名字</button>
        </div>
        
        <div class="name-list">
            <h2>女性名字</h2>
            <div id="femaleNames"></div>
            <button onclick="addFemaleName()">添加女性名字</button>
        </div>

        <div class="name-list">
            <h2>昵称</h2>
            <div id="nicknamesNames"></div>
            <button onclick="addNickname()">添加昵称</button>
        </div>
    </div>

    <textarea id="exportArea" placeholder="导出的 JSON 将显示在这里"></textarea>

    <script>
        let nameData = {
            male: [],
            female: [],
            nicknames: []
        };

        function createNameEntry(gender, name = { en: '', zh: '' }) {
            const div = document.createElement('div');
            div.className = 'name-entry';
            
            const enInput = document.createElement('input');
            enInput.value = name.en;
            enInput.placeholder = '英文名';
            enInput.onchange = () => updateName(gender, div, 'en', enInput.value);
            
            const zhInput = document.createElement('input');
            zhInput.value = name.zh;
            zhInput.placeholder = '中文名';
            zhInput.onchange = () => updateName(gender, div, 'zh', zhInput.value);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '×';
            deleteBtn.className = 'delete-btn';
            deleteBtn.onclick = () => deleteName(gender, div);
            
            div.appendChild(enInput);
            div.appendChild(zhInput);
            div.appendChild(deleteBtn);
            
            document.getElementById(gender + 'Names').appendChild(div);
            return div;
        }

        function updateName(gender, element, lang, value) {
            const index = Array.from(element.parentNode.children).indexOf(element);
            if (!nameData[gender][index]) {
                nameData[gender][index] = { en: '', zh: '' };
            }
            nameData[gender][index][lang] = value;
        }

        function deleteName(gender, element) {
            const index = Array.from(element.parentNode.children).indexOf(element);
            nameData[gender].splice(index, 1);
            element.remove();
        }

        function addMaleName() {
            nameData.male.push({ en: '', zh: '' });
            createNameEntry('male');
        }

        function addFemaleName() {
            nameData.female.push({ en: '', zh: '' });
            createNameEntry('female');
        }

        function addNickname() {
            nameData.nicknames.push({ en: '', zh: '' });
            createNameEntry('nicknames');
        }

        async function importFiles() {
            try {
                const nameResponse = await fetch('../data/of_npcp/name.json');
                const zhResponse = await fetch('../data/of_npcp/lang/zh.json');
                const enResponse = await fetch('../data/of_npcp/lang/en.json');
                
                const nameJson = await nameResponse.json();
                const zhJson = await zhResponse.json();
                const enJson = await enResponse.json();

                // 清空现有数据
                nameData = { male: [], female: [], nicknames: [] };
                document.getElementById('maleNames').innerHTML = '';
                document.getElementById('femaleNames').innerHTML = '';
                document.getElementById('nicknamesNames').innerHTML = '';

                // 导入数据
                nameJson.male.forEach(key => {
                    const name = key.replace('name.male.', '');
                    const entry = {
                        en: enJson.name.male[name],
                        zh: zhJson.name.male[name]
                    };
                    nameData.male.push(entry);
                    createNameEntry('male', entry);
                });

                nameJson.female.forEach(key => {
                    const name = key.replace('name.female.', '');
                    const entry = {
                        en: enJson.name.female[name],
                        zh: zhJson.name.female[name]
                    };
                    nameData.female.push(entry);
                    createNameEntry('female', entry);
                });

                nameJson.nicknames.forEach(key => {
                    const name = key.replace('nickname.', '');
                    const entry = {
                        en: enJson.nickname[name],
                        zh: zhJson.nickname[name]
                    };
                    nameData.nicknames.push(entry);
                    createNameEntry('nicknames', entry);
                });

            } catch (error) {
                alert('导入文件失败：' + error.message);
            }
        }

        function exportFiles() {
            // 生成 name.json
            const nameJson = {
                male: nameData.male.map(n => `name.male.${n.en}`),
                female: nameData.female.map(n => `name.female.${n.en}`),
                nicknames: nameData.nicknames.map(n => `nickname.${formatNickname(n.en)}`)
            };

            // 生成本地化文件
            const zhJson = { name: { male: {}, female: {} }, nickname: {} };
            const enJson = { name: { male: {}, female: {} }, nickname: {} };

            nameData.male.forEach(name => {
                zhJson.name.male[name.en] = name.zh;
                enJson.name.male[name.en] = name.en;
            });

            nameData.female.forEach(name => {
                zhJson.name.female[name.en] = name.zh;
                enJson.name.female[name.en] = name.en;
            });

            nameData.nicknames.forEach(name => {
                const formattedKey = formatNickname(name.en);
                zhJson.nickname[formattedKey] = name.zh;
                enJson.nickname[formattedKey] = name.en;
            });

            // 显示导出结果
            const exportData = {
                'name.json': nameJson,
                'zh.json': zhJson,
                'en.json': enJson
            };

            document.getElementById('exportArea').value = 
                JSON.stringify(exportData, null, 2);
        }

        // 添加格式化昵称的辅助函数
        function formatNickname(nickname) {
            return nickname
                .toLowerCase()
                .replace(/\s+/g, '_');
        }

        async function manualImport(files) {
            try {
                const fileContents = await Promise.all(
                    Array.from(files).map(file => file.text())
                );
                
                const filesData = fileContents.map(content => JSON.parse(content));
                let nameJson, zhJson, enJson;
                
                filesData.forEach(data => {
                    if (data.male && data.male[0]?.startsWith('name.male.')) {
                        nameJson = data;
                    } else if (data.name?.male) {
                        if (Object.values(data.name.male)[0].match(/[\u4e00-\u9fa5]/)) {
                            zhJson = data;
                        } else {
                            enJson = data;
                        }
                    }
                });

                // 清空现有数据
                nameData = { male: [], female: [], nicknames: [] };
                document.getElementById('maleNames').innerHTML = '';
                document.getElementById('femaleNames').innerHTML = '';
                document.getElementById('nicknamesNames').innerHTML = '';

                // 导入数据
                nameJson.male.forEach(key => {
                    const name = key.replace('name.male.', '');
                    const entry = {
                        en: enJson.name.male[name],
                        zh: zhJson.name.male[name]
                    };
                    nameData.male.push(entry);
                    createNameEntry('male', entry);
                });

                nameJson.female.forEach(key => {
                    const name = key.replace('name.female.', '');
                    const entry = {
                        en: enJson.name.female[name],
                        zh: zhJson.name.female[name]
                    };
                    nameData.female.push(entry);
                    createNameEntry('female', entry);
                });

                nameJson.nicknames.forEach(key => {
                    const name = key.replace('nickname.', '');
                    const entry = {
                        en: enJson.nickname[name],
                        zh: zhJson.nickname[name]
                    };
                    nameData.nicknames.push(entry);
                    createNameEntry('nicknames', entry);
                });

            } catch (error) {
                alert('导入文件失败：' + error.message);
            }
        }
    </script>
</body>
</html> 